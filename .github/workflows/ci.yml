name: CI/CD Pipeline - Docker + Kubernetes

on:
  push:
    branches:
      - main

concurrency:
  group: docker-k8s-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/java-docker-ci
      KUBECONFIG: ${{ github.workspace }}/.kube/config
      K8S_NAMESPACE: default

    steps:
      # 1️⃣ Checkout Repository
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2️⃣ Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3️⃣ Build Docker Image (SHA + latest)
      - name: Build Docker Image
        run: |
          docker build -t "$IMAGE_NAME:${{ github.sha }}" .
          docker tag "$IMAGE_NAME:${{ github.sha }}" "$IMAGE_NAME:latest"

      # 4️⃣ Push Image to Docker Hub
      - name: Push Docker Image
        run: |
          docker push "$IMAGE_NAME:${{ github.sha }}"
          docker push "$IMAGE_NAME:latest"

      # 5️⃣ Set up kubectl
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      # 6️⃣ Configure Kubeconfig
      # Prefer base64-encoded kubeconfig in secret KUBE_CONFIG_B64
      - name: Configure Kubeconfig
        run: |
          mkdir -p "$(dirname "$KUBECONFIG")"
          if [ -n "${{ secrets.KUBE_CONFIG_B64 }}" ]; then
            echo "${{ secrets.KUBE_CONFIG_B64 }}" | base64 -d > "$KUBECONFIG"
          else
            # Fallback if you stored raw kubeconfig in KUBE_CONFIG (not base64)
            cat > "$KUBECONFIG" <<'EOF'
${{ secrets.KUBE_CONFIG }}
EOF
          fi
          chmod 600 "$KUBECONFIG"

      # 7️⃣ Verify cluster connectivity
      - name: Verify Cluster
        run: |
          kubectl cluster-info
          kubectl get nodes -o wide
          kubectl get ns "$K8S_NAMESPACE"

      # 8️⃣ Update Image in Deployment
      - name: Update Deployment Image
        run: |
          CONTAINER_NAME="java-ci-container"  # <-- change if your container name differs
          kubectl -n "$K8S_NAMESPACE" set image deployment/java-ci-deployment \
            "$CONTAINER_NAME=$IMAGE_NAME:${{ github.sha }}"

      # 9️⃣ Rollout Status
      - name: Rollout Status
        run: |
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/java-ci-deployment --timeout=180s
