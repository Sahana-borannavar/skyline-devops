name: CI/CD Pipeline - Docker + Kubernetes

on:
  push:
    branches:
      - main

concurrency:
  group: docker-k8s-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/java-docker-ci
      KUBECONFIG: ${{ github.workspace }}/.kube/config
      # If you use a non-default namespace, set it here:
      K8S_NAMESPACE: default

    steps:
      # 1ï¸âƒ£ Checkout Repository
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Set up Docker Buildx (for better caching)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3ï¸âƒ£ Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4ï¸âƒ£ Build Docker Image (tagged with SHA + latest)
      - name: Build Docker Image
        run: |
          docker build -t "$IMAGE_NAME:${{ github.sha }}" .
          docker tag "$IMAGE_NAME:${{ github.sha }}" "$IMAGE_NAME:latest"

      # 5ï¸âƒ£ Push Image to Docker Hub
      - name: Push Docker Image
        run: |
          docker push "$IMAGE_NAME:${{ github.sha }}"
          docker push "$IMAGE_NAME:latest"

      # 6ï¸âƒ£ Set up kubectl
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      # 7ï¸âƒ£ Configure Kubeconfig
      # Recommended: store base64-encoded kubeconfig in secret KUBE_CONFIG_B64
      - name: Configure Kubeconfig
        run: |
          mkdir -p "$(dirname "$KUBECONFIG")"
          if [ -n "${{ secrets.KUBE_CONFIG_B64 }}" ]; then
            echo "${{ secrets.KUBE_CONFIG_B64 }}" | base64 -d > "$KUBECONFIG"
          else
            # Fallback if you stored raw kubeconfig in KUBE_CONFIG (not base64)
            cat > "$KUBECONFIG" <<'EOF'
${{ secrets.KUBE_CONFIG }}
EOF
          fi
          chmod 600 "$KUBECONFIG"

      # 8ï¸âƒ£ Verify cluster connectivity
      - name: Verify Cluster
        run: |
          kubectl cluster-info
          kubectl get nodes -o wide
          # If you use a custom namespace, ensure it exists:
          kubectl get ns "$K8S_NAMESPACE"

      # 9ï¸âƒ£ Update Deployment Image
      - name: Update Deployment Image
        run: |
          # Adjust container name if different:
          CONTAINER_NAME="java-ci-container"
          kubectl -n "$K8S_NAMESPACE" set image deployment/java-ci-deployment \
            "$CONTAINER_NAME=$IMAGE_NAME:${{ github.sha }}"

      # ðŸ”Ÿ Wait for rollout
      - name: Rollout Status
        run: |
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/java-ci-deployment --timeout=180s
